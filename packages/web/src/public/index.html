<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poker Scenario Analyzer</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header>
      <div class="header-content">
        <div class="header-title">
          <h1>üé¥ Poker Scenario Analyzer</h1>
          <p class="subtitle">Omaha strategic hand analysis (4/5/6-card)</p>
        </div>
        <button class="settings-btn" id="settings-btn" title="AI Settings">‚öôÔ∏è</button>
      </div>
      <div class="deploy-info" id="deploy-info" title="Deployment timestamp"></div>
    </header>

    <main>
      <!-- Data Status Indicators -->
      <div id="data-status" style="display: none;"></div>
      <div id="storage-status"></div>

      <!-- Tab Navigation -->
      <nav class="main-tabs">
        <button class="tab-btn active" data-tab="scenario">Scenario Builder</button>
        <button class="tab-btn" data-tab="matrix">Probability Matrix</button>
        <button class="tab-btn" data-tab="saved">Saved Analysis</button>
      </nav>

      <!-- Scenario Builder Tab -->
      <section id="scenario-tab" class="tab-content active">
        <!-- Onboarding intro card -->
        <div class="intro-card" id="scenario-intro" data-storage-key="scenario-intro-collapsed">
          <div class="intro-card-header" onclick="toggleIntroCard('scenario-intro')">
            <span class="intro-card-icon">üéØ</span>
            <span class="intro-card-title">Build a hand and see what to expect</span>
            <span class="intro-card-toggle">‚ñº</span>
          </div>
          <div class="intro-card-body">
            <p>Configure a starting hand scenario ‚Äî structure, suitedness, table size ‚Äî and see the odds of making sets, flushes, straights and more. Great for studying spots before you play.</p>
            <button class="intro-card-dismiss" onclick="collapseIntroCard('scenario-intro')">Got it</button>
          </div>
        </div>
        <div class="scenario-builder">
          <!-- Game Settings Row -->
          <div class="settings-row">
            <div class="setting">
              <label>Game</label>
              <select id="game-select">
                <option value="omaha4" selected>Omaha 4-Card</option>
                <option value="omaha5">Omaha 5-Card</option>
                <option value="omaha6">Omaha 6-Card</option>
              </select>
            </div>
            <div class="setting">
              <label>Position</label>
              <select id="position-select">
                <option value="UTG">UTG (Early)</option>
                <option value="MP">MP (Middle)</option>
                <option value="CO">CO (Cutoff)</option>
                <option value="BTN" selected>BTN (Button)</option>
                <option value="SB">SB (Small Blind)</option>
                <option value="BB">BB (Big Blind)</option>
              </select>
            </div>
            <div class="setting">
              <label>Style</label>
              <select id="style-select">
                <option value="rock">Rock (Tight-Passive)</option>
                <option value="tag" selected>TAG (Tight-Aggressive)</option>
                <option value="lag">LAG (Loose-Aggressive)</option>
              </select>
            </div>
          </div>

          <!-- Opponents Row -->
          <div class="settings-row opponents-row">
            <div class="setting">
              <label title="Total players at the table (not just those in the pot). Position determines how many will likely enter.">Players at Table</label>
              <div class="opponent-selector">
                <button class="opp-btn" data-count="1">1</button>
                <button class="opp-btn" data-count="2">2</button>
                <button class="opp-btn" data-count="3">3</button>
                <button class="opp-btn" data-count="4">4</button>
                <button class="opp-btn active" data-count="5">5</button>
                <button class="opp-btn" data-count="6">6</button>
                <button class="opp-btn" data-count="7">7</button>
                <button class="opp-btn" data-count="8">8</button>
              </div>
            </div>
            <div class="multiway-alert" id="multiway-alert" style="display: none;">
              <span class="alert-icon">‚ö†Ô∏è</span>
              <span class="alert-text">Large table: Expect multiway pots - tighten range, prioritize nut potential!</span>
            </div>
          </div>

          <!-- Quick Presets (Primary UI) -->
          <div class="preset-grid">
            <button class="preset-chip active" data-query="pair:AA:ds">AA ds</button>
            <button class="preset-chip" data-query="pair:KK:ds">KK ds</button>
            <button class="preset-chip" data-query="pair:TT+:ds">TT+ ds</button>
            <button class="preset-chip" data-query="run:A+:ds">Rundown ds</button>
            <button class="preset-chip" data-query="dpair:any:ds">DblPair ds</button>
            <button class="preset-chip" data-query="bway:any:ds">Bway ds</button>
            <button class="preset-chip" data-query="pair:any:any">Any Pair</button>
            <button class="preset-chip" data-query="any:any:any">Any Hand</button>
          </div>

          <!-- Compact Custom Builder -->
          <div class="compact-builder">
            <div class="builder-row">
              <div class="builder-cell">
                <select id="structure-select" class="compact-select">
                  <option value="pair" selected>Pair</option>
                  <option value="dpair">Double Pair</option>
                  <option value="run">Rundown</option>
                  <option value="bway">Broadway</option>
                  <option value="any">Any</option>
                </select>
              </div>

              <div class="builder-cell rank-cell" id="rank-cell">
                <button class="rank-adj" id="rank-down">‚óÄ</button>
                <span class="rank-display" id="rank-display">A</span>
                <button class="rank-adj" id="rank-up">‚ñ∂</button>
                <div class="rank-mod-toggle">
                  <button class="rank-mod" data-mod="-" title="Lower kickers (e.g., AA with 7-6)">‚àí</button>
                  <button class="rank-mod active" data-mod="=" title="Average kickers (e.g., AA with Q-J)">=</button>
                  <button class="rank-mod" data-mod="+" title="Premium kickers (e.g., AA with A-K suited)">+</button>
                </div>
              </div>

              <div class="builder-cell">
                <select id="suit-select" class="compact-select">
                  <option value="ds" selected>DS</option>
                  <option value="ss">SS</option>
                  <option value="r">Rainbow</option>
                  <option value="any">Any</option>
                </select>
              </div>

              <div class="builder-cell" id="sidecards-cell">
                <select id="sidecards-select" class="compact-select">
                  <option value="any" selected>Any</option>
                  <option value="conn">Conn</option>
                  <option value="bway">Bway</option>
                  <option value="wheel">Wheel</option>
                </select>
              </div>
            </div>

            <!-- Tags for active constraints -->
            <div class="constraint-tags" id="constraint-tags">
              <span class="tag">Pair <button class="tag-remove" data-tag="structure">√ó</button></span>
              <span class="tag">Aces <button class="tag-remove" data-tag="rank">√ó</button></span>
              <span class="tag">DS <button class="tag-remove" data-tag="suit">√ó</button></span>
            </div>
          </div>

          <!-- Query Preview (Compact) -->
          <div class="query-preview">
            <div class="query-header">
              <code id="query-code">pair:AA:ds</code>
              <button id="copy-query" class="icon-btn" title="Copy">üìã</button>
            </div>
            <div class="query-description" id="query-description">Pair Aces double-suited</div>
            <div class="sample-hands">
              <div class="hand-cards" id="hand-cards">
                <span class="example-hand">A‚ô†A‚ô•K‚ô†Q‚ô•</span>
                <span class="example-hand">A‚ô¶A‚ô£8‚ô¶6‚ô£</span>
                <span class="example-hand">A‚ô†A‚ô•5‚ô†3‚ô•</span>
              </div>
            </div>
          </div>

          <!-- Strategy Insight Panel -->
          <div class="strategy-insight" id="strategy-insight">
            <div class="insight-header">
              <span class="insight-title">Strategy Insight</span>
              <span class="insight-context" id="insight-context">TAG @ BTN vs 5</span>
            </div>
            <div class="insight-recommendation" id="insight-recommendation">
              <span class="rec-badge rec-raise" id="rec-badge">RAISE</span>
              <span class="rec-text" id="rec-text">Premium hand, strong in position</span>
            </div>
            <div class="insight-details">
              <div class="insight-row">
                <span class="insight-label">Nut Potential:</span>
                <div class="mini-bar">
                  <div class="mini-bar-fill" id="nut-potential-bar" style="width: 85%"></div>
                </div>
                <span class="insight-value" id="nut-potential-val">High</span>
              </div>
              <div class="insight-row">
                <span class="insight-label">Multiway Viability:</span>
                <div class="mini-bar">
                  <div class="mini-bar-fill" id="multiway-bar" style="width: 60%"></div>
                </div>
                <span class="insight-value" id="multiway-val">Medium</span>
              </div>
            </div>
            <div class="insight-warnings" id="insight-warnings">
              <!-- Warnings populated by JS -->
            </div>
            <div class="insight-actions">
              <button class="explain-btn" id="explain-btn">
                <span>üí¨</span> Explain This
              </button>
            </div>
          </div>

          <!-- Analyze Button -->
          <button id="analyze-btn" class="primary-btn">
            <span class="btn-icon">üîç</span>
            <span class="btn-text">Analyze Scenario</span>
          </button>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section" style="display: none;">
          <!-- Results Header with Actions -->
          <div class="results-header">
            <h3 id="results-title">Analysis Results</h3>
            <div class="results-actions">
              <button class="action-link" onclick="viewInMatrixWithHighlight()">üìä View in Matrix</button>
            </div>
          </div>
          <!-- Summary Stats -->
          <div class="results-summary">
            <div class="summary-grid">
              <div class="stat-card">
                <div class="stat-value" id="stat-winrate">--</div>
                <div class="stat-label">Win Rate</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat-hands">--</div>
                <div class="stat-label">Hands Analyzed</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="stat-frequency">--</div>
                <div class="stat-label">Occurrence</div>
              </div>
            </div>
          </div>

          <!-- Strategic Scores -->
          <div class="strategic-scores">
            <h4>Strategic Profile</h4>
            <div class="score-bars">
              <div class="score-row">
                <span class="score-label">Nut Potential</span>
                <div class="score-bar">
                  <div class="score-fill" id="score-nut" style="width: 0%"></div>
                </div>
                <span class="score-value" id="score-nut-val">--</span>
              </div>
              <div class="score-row">
                <span class="score-label">RNIO Risk</span>
                <div class="score-bar risk">
                  <div class="score-fill" id="score-rnio" style="width: 0%"></div>
                </div>
                <span class="score-value" id="score-rnio-val">--</span>
              </div>
              <div class="score-row">
                <span class="score-label">Multiway Strength</span>
                <div class="score-bar">
                  <div class="score-fill" id="score-multiway" style="width: 0%"></div>
                </div>
                <span class="score-value" id="score-multiway-val">--</span>
              </div>
            </div>
          </div>

          <!-- Flop Guidance -->
          <div class="flop-guidance">
            <h4>What to Look For on the Flop</h4>
            <div class="flop-columns">
              <div class="flop-column good">
                <h5>‚úì Good Flops</h5>
                <ul id="good-flops">
                  <li>Dry, rainbow boards</li>
                  <li>Top set opportunities</li>
                  <li>Nut flush draws</li>
                </ul>
              </div>
              <div class="flop-column danger">
                <h5>‚ö† Dangerous Flops</h5>
                <ul id="danger-flops">
                  <li>Monotone without nut FD</li>
                  <li>Very connected boards</li>
                  <li>Paired + coordinated</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Multiway Adjustment -->
          <div class="multiway-table">
            <h4>Win Rate by Table Size</h4>
            <table id="multiway-results">
              <thead>
                <tr>
                  <th>Players</th>
                  <th>Win Rate</th>
                  <th>Nut Required?</th>
                  <th>Strategy</th>
                </tr>
              </thead>
              <tbody id="multiway-body">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Matrix Tab -->
      <section id="matrix-tab" class="tab-content">
        <!-- Onboarding intro card -->
        <div class="intro-card" id="matrix-intro" data-storage-key="matrix-intro-collapsed">
          <div class="intro-card-header" onclick="toggleIntroCard('matrix-intro')">
            <span class="intro-card-icon">üí°</span>
            <span class="intro-card-title">You made your hand ‚Äî but how worried should you be?</span>
            <span class="intro-card-toggle">‚ñº</span>
          </div>
          <div class="intro-card-body">
            <p>This matrix shows the probability that opponents hold each hand type when <strong>you</strong> have a specific hand. A flush feels strong, but if 40% of opponents also have flushes, you need to be cautious. Use this to calibrate your aggression.</p>
            <p class="intro-card-hint">üìä <strong>Click any cell</strong> to explore that matchup in the Scenario Builder</p>
            <button class="intro-card-dismiss" onclick="collapseIntroCard('matrix-intro')">Got it</button>
          </div>
        </div>
        <div class="matrix-controls">
          <div class="control-row">
            <div class="control-group">
              <label>Game Variant</label>
              <select id="matrix-game">
                <option value="omaha4" selected>Omaha 4-Card</option>
                <option value="omaha5">Omaha 5-Card</option>
                <option value="omaha6">Omaha 6-Card</option>
              </select>
            </div>
            <div class="control-group">
              <label>Players at Table</label>
              <select id="matrix-players">
                <option value="2">2 Players</option>
                <option value="3">3 Players</option>
                <option value="4">4 Players</option>
                <option value="5">5 Players</option>
                <option value="6" selected>6 Players</option>
                <option value="7">7 Players</option>
                <option value="8">8 Players</option>
                <option value="9">9 Players</option>
              </select>
            </div>
            <button id="run-matrix" class="secondary-btn" style="display: none;">Refresh</button>
            <button id="matrix-zoom-toggle" class="zoom-toggle-btn" onclick="toggleMatrixZoom()" title="Toggle zoom level">
              <span class="zoom-icon">üîç</span>
              <span class="zoom-label">Fit to Screen</span>
            </button>
          </div>
        </div>

        <div id="matrix-progress" class="progress-container" style="display: none;">
          <div class="progress-bar">
            <div id="matrix-progress-fill" class="progress-fill"></div>
          </div>
          <span id="matrix-progress-text">0%</span>
        </div>

        <div id="matrix-container" class="matrix-display">
          <p class="placeholder">Run a simulation to see the probability matrix</p>
        </div>
      </section>

      <!-- Saved Tab -->
      <section id="saved-tab" class="tab-content">
        <div class="saved-header">
          <h3>Saved Simulations</h3>
          <button id="refresh-saved" class="icon-btn" title="Refresh">üîÑ</button>
        </div>
        <div id="saved-list" class="saved-list">
          <p class="loading">Loading...</p>
        </div>
      </section>
    </main>

    <footer>
      <p>Poker Scenario Analyzer v2.0</p>
    </footer>
  </div>

  <!-- AI Settings Modal -->
  <div class="modal-overlay" id="settings-modal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h3>ü§ñ AI Coach Settings</h3>
        <button class="modal-close" id="close-settings">√ó</button>
      </div>
      <div class="modal-body">
        <div class="settings-intro">
          <p><strong>üéØ Get personalized poker insights</strong></p>
          <p>The AI Coach analyzes your specific scenario and provides:</p>
          <ul>
            <li>Whether your hand is playable and why</li>
            <li>Key statistics (set probability, flush draw odds, etc.)</li>
            <li>What to look for on the flop</li>
            <li>Warnings for your specific situation</li>
          </ul>
          <p class="privacy-note">üîí Your API key is stored locally and never sent to our servers.</p>
        </div>

        <div class="setting-group">
          <label>AI Provider</label>
          <select id="ai-provider">
            <option value="gemini" selected>Google Gemini (Free Tier)</option>
            <option value="groq">Groq (Free Tier)</option>
            <option value="anthropic">Anthropic (Claude)</option>
            <option value="openai">OpenAI (GPT-4)</option>
          </select>
        </div>

        <div class="setting-group">
          <label>API Key</label>
          <div class="key-input-group">
            <input type="password" id="ai-api-key" placeholder="Enter your API key...">
            <button class="toggle-visibility" id="toggle-key-visibility">üëÅÔ∏è</button>
          </div>
          <p class="setting-hint">
            <span id="provider-hint">üÜì Free tier! Get key at <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a></span>
          </p>
        </div>

        <div class="setting-group">
          <button class="test-connection-btn" id="test-connection">Test Connection</button>
          <span class="connection-status" id="connection-status"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-btn" id="cancel-settings">Cancel</button>
        <button class="primary-btn" id="save-settings">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Help Modal for Matrix -->
  <div class="modal" id="help-modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3>üìä Understanding the Threat Landscape Matrix</h3>
        <button class="modal-close" id="close-help">√ó</button>
      </div>
      <div class="modal-body" style="text-align: left; line-height: 1.6;">
        <h4>What does this matrix show?</h4>
        <p>Each cell answers: <strong>"When I have [ROW hand], what % of hands have at least one opponent with [COLUMN hand]?"</strong></p>
        
        <h4 style="margin-top: 16px;">Example Reading</h4>
        <p>If the cell for "One Pair ‚Üí Two Pair" shows <strong>85%</strong>, that means:</p>
        <ul style="margin-left: 20px;">
          <li>When you have One Pair, 85% of all hands dealt will have at least one opponent with Two Pair</li>
          <li>This is NOT your win rate ‚Äî it's how often you FACE this hand type</li>
        </ul>
        
        <h4 style="margin-top: 16px;">Why values can exceed 100% across a row</h4>
        <p>Multiple opponents can have different best hands simultaneously. In a 6-player pot, you might face:</p>
        <ul style="margin-left: 20px;">
          <li>One opponent with Two Pair (counted in that column)</li>
          <li>Another opponent with a Flush (counted in that column)</li>
          <li>So both columns get incremented for the same hand</li>
        </ul>
        
        <h4 style="margin-top: 16px;">Color Guide</h4>
        <p><span style="background: #dcfce7; padding: 2px 8px; border-radius: 4px;">Green</span> = Rare threat (you don't face this often)</p>
        <p><span style="background: #fde047; padding: 2px 8px; border-radius: 4px;">Yellow</span> = Moderate threat (fairly common)</p>
        <p><span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px;">Red</span> = Very common threat (expect to face this frequently)</p>
        
        <h4 style="margin-top: 16px;">Strategic Use</h4>
        <p>Use this matrix to understand your <strong>vulnerability</strong>:</p>
        <ul style="margin-left: 20px;">
          <li>High % in stronger hand columns = your hand is very vulnerable</li>
          <li>More players at table = higher threat percentages across the board</li>
          <li>Helps decide whether to fold, call, or raise based on likely opposition</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="primary-btn" id="close-help-btn">Got it!</button>
      </div>
    </div>
  </div>

  <!-- AI Coach Panel -->
  <div class="ai-panel" id="ai-panel" style="display: none;">
    <div class="ai-panel-header">
      <span class="ai-panel-title">üéì AI Coach</span>
      <div class="ai-panel-actions">
        <button class="ai-panel-btn" id="new-chat" title="New conversation">üîÑ</button>
        <button class="ai-panel-btn" id="close-ai-panel" title="Close">√ó</button>
      </div>
    </div>
    <div class="ai-panel-messages" id="ai-messages">
      <!-- Messages populated by JS -->
    </div>
    <div class="ai-panel-input">
      <input type="text" id="ai-input" placeholder="Ask a follow-up question...">
      <button class="send-btn" id="send-ai-message">Send</button>
    </div>
  </div>

  <!-- No API Key Prompt -->
  <div class="no-key-prompt" id="no-key-prompt" style="display: none;">
    <p>To use AI explanations, you'll need to configure your API key.</p>
    <button class="primary-btn small" id="open-settings-from-prompt">Configure AI</button>
  </div>

  <script src="poker-stats.js"></script>
  <script src="data-manager.js"></script>
  <script src="app.js"></script>
</body>
</html>
